#cloud-config
# vim: syntax=yaml

hostname: ${node_name}
users:
  - name: ${node_ssh_user} 
    plain_text_passwd: ${node_ssh_password}
    ssh_authorized_keys:
    - ${node_ssh_key}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users

chpasswd: 
  expire: False
ssh_pwauth: True

# growpart:
#   mode: auto
#   devices: ['/']
#   ignore_growroot_disabled: false


write_files:
  - path: /etc/sudoers.d/${ad_group}
    permissions: '0440'
    content: |
      ${ad_group} ALL=(ALL) ALL
  - path: /etc/rancher/rke2/config.yaml
    content: | 
      server: https://${init_node_ip}:9345
      write-kubeconfig-mode: "0640"
      token: ${rke2_token}
      tls-san:
        - ${url}      
  - path: /opt/rke2-install.sh
    encoding: b64
    content: "IyEvYmluL3NoCgpzZXQgLWUKCmlmIFsgIiR7REVCVUd9IiA9IDEgXTsgdGhlbgogICAgc2V0IC14CmZpCgojIFVzYWdlOgojICAgY3VybCAuLi4gfCBFTlZfVkFSPS4uLiBzaCAtCiMgICAgICAgb3IKIyAgIEVOVl9WQVI9Li4uIC4vaW5zdGFsbC5zaAojCgojIEVudmlyb25tZW50IHZhcmlhYmxlczoKIwojICAgLSBJTlNUQUxMX1JLRTJfQ0hBTk5FTAojICAgICBDaGFubmVsIHRvIHVzZSBmb3IgZmV0Y2hpbmcgcmtlMiBkb3dubG9hZCBVUkwuCiMgICAgIERlZmF1bHRzIHRvICdzdGFibGUnLgojCiMgICAtIElOU1RBTExfUktFMl9NRVRIT0QKIyAgICAgVGhlIGluc3RhbGxhdGlvbiBtZXRob2QgdG8gdXNlLgojICAgICBEZWZhdWx0IGlzIG9uIFJQTS1iYXNlZCBzeXN0ZW1zIGlzICJycG0iLCBhbGwgZWxzZSAidGFyIi4KIwojICAgLSBJTlNUQUxMX1JLRTJfVFlQRQojICAgICBUeXBlIG9mIHJrZTIgc2VydmljZS4gQ2FuIGJlIGVpdGhlciAic2VydmVyIiBvciAiYWdlbnQiLgojICAgICBEZWZhdWx0IGlzICJzZXJ2ZXIiLgojCiMgICAtIElOU1RBTExfUktFMl9FWEVDCiMgICAgIFRoaXMgaXMgYW4gYWxpYXMgZm9yIElOU1RBTExfUktFMl9UWVBFLCBpbmNsdWRlZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEszcy4KIyAgICAgSWYgYm90aCBhcmUgc2V0LCBJTlNUQUxMX1JLRTJfVFlQRSBpcyBwcmVmZXJyZWQuCiMKIyAgIC0gSU5TVEFMTF9SS0UyX1ZFUlNJT04KIyAgICAgVmVyc2lvbiBvZiBya2UyIHRvIGRvd25sb2FkIGZyb20gZ2l0aHViLgojCiMgICAtIElOU1RBTExfUktFMl9SUE1fUkVMRUFTRV9WRVJTSU9OCiMgICAgIFZlcnNpb24gb2YgdGhlIHJrZTIgUlBNIHJlbGVhc2UgdG8gaW5zdGFsbC4KIyAgICAgRm9ybWF0IHdvdWxkIGJlIGxpa2UgIjEuZWw3IiBvciAiMi5lbDgiCiMKIyAgIC0gSU5TVEFMTF9SS0UyX1RBUl9QUkVGSVgKIyAgICAgSW5zdGFsbGF0aW9uIHByZWZpeCB3aGVuIHVzaW5nIHRoZSB0YXIgaW5zdGFsbGF0aW9uIG1ldGhvZC4KIyAgICAgRGVmYXVsdCBpcyAvdXNyL2xvY2FsLCB1bmxlc3MgL3Vzci9sb2NhbCBpcyByZWFkLW9ubHkgb3IgaGFzIGEgZGVkaWNhdGVkIG1vdW50IHBvaW50LAojICAgICBpbiB3aGljaCBjYXNlIC9vcHQvcmtlMiBpcyB1c2VkIGluc3RlYWQuCiMKIyAgIC0gSU5TVEFMTF9SS0UyX0NPTU1JVAojICAgICBDb21taXQgb2YgUktFMiB0byBkb3dubG9hZCBmcm9tIHRlbXBvcmFyeSBjbG91ZCBzdG9yYWdlLgojICAgICBGb3IgZGV2ZWxvcGVyICYgUUEgdXNlIG9ubHkKIwojICAgLSBJTlNUQUxMX1JLRTJfQUdFTlRfSU1BR0VTX0RJUgojICAgICBJbnN0YWxsYXRpb24gcGF0aCBmb3IgYWlyZ2FwIGltYWdlcyB3aGVuIGluc3RhbGxpbmcgZnJvbSBDSSBjb21taXQKIyAgICAgRGVmYXVsdCBpcyAvdmFyL2xpYi9yYW5jaGVyL3JrZTIvYWdlbnQvaW1hZ2VzCiMKIyAgIC0gSU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEgKIyAgICAgSWYgc2V0LCB0aGUgaW5zdGFsbCBzY3JpcHQgd2lsbCB1c2UgdGhlIGxvY2FsIHBhdGggZm9yIHNvdXJjaW5nIHRoZSBya2UyLmxpbnV4LSRTVUZGSVggYW5kIHNoYTI1NnN1bS0kQVJDSC50eHQgZmlsZXMKIyAgICAgcmF0aGVyIHRoYW4gdGhlIGRvd25sb2FkaW5nIHRoZSBmaWxlcyBmcm9tIHRoZSBpbnRlcm5ldC4KIyAgICAgRGVmYXVsdCBpcyBub3Qgc2V0LgojCiMgICAtIElOU1RBTExfUktFMl9TS0lQX1JFTE9BRAojICAgICBJZiBzZXQsIHRoZSBpbnN0YWxsIHNjcmlwdCB3aWxsIHNraXAgcmVsb2FkaW5nIHN5c3RlbWN0bCBkYWVtb24gYWZ0ZXIgdGhlIHRhciBoYXMgYmVlbiBleHRyYWN0ZWQgYW5kIHN5c3RlbWQgdW5pdHMKIyAgICAgaGF2ZSBiZWVuIG1vdmVkLgojICAgICBEZWZhdWx0IGlzIG5vdCBzZXQuCiMKIyAgIC0gSU5TVEFMTF9SS0UyX1NLSVBfRkFQT0xJQ1kKIyAgICAgSWYgc2V0LCB0aGUgaW5zdGFsbCBzY3JpcHQgd2lsbCBza2lwIGFkZGluZyBmYXBvbGljeSBydWxlcwojICAgICBEZWZhdWx0IGlzIG5vdCBzZXQuCgoKIyBpbmZvIGxvZ3MgdGhlIGdpdmVuIGFyZ3VtZW50IGF0IGluZm8gbG9nIGxldmVsLgppbmZvKCkgewogICAgZWNobyAiW0lORk9dICIgIiRAIgp9CgojIHdhcm4gbG9ncyB0aGUgZ2l2ZW4gYXJndW1lbnQgYXQgd2FybiBsb2cgbGV2ZWwuCndhcm4oKSB7CiAgICBlY2hvICJbV0FSTl0gIiAiJEAiID4mMgp9CgojIGZhdGFsIGxvZ3MgdGhlIGdpdmVuIGFyZ3VtZW50IGF0IGZhdGFsIGxvZyBsZXZlbC4KZmF0YWwoKSB7CiAgICBlY2hvICJbRVJST1JdICIgIiRAIiA+JjIKICAgIGlmIFsgLW4gIiR7U1VGRklYfSIgXTsgdGhlbgogICAgICAgIGVjaG8gIltBTFRdIFBsZWFzZSB2aXNpdCAnaHR0cHM6Ly9naXRodWIuY29tL3JhbmNoZXIvcmtlMi9yZWxlYXNlcycgZGlyZWN0bHkgYW5kIGRvd25sb2FkIHRoZSBsYXRlc3QgcmtlMi4ke1NVRkZJWH0udGFyLmd6IiA+JjIKICAgIGZpCiAgICBleGl0IDEKfQoKIyBjaGVja190YXJnZXRfbW91bnRwb2ludCByZXR1cm4gc3VjY2VzcyBpZiB0aGUgdGFyZ2V0IGRpcmVjdG9yeSBpcyBvbiBhIGRlZGljYXRlZCBtb3VudCBwb2ludApjaGVja190YXJnZXRfbW91bnRwb2ludCgpIHsKICAgIG1vdW50cG9pbnQgLXEgIiR7SU5TVEFMTF9SS0UyX1RBUl9QUkVGSVh9Igp9CgojIGNoZWNrX3RhcmdldF9ybyByZXR1cm5zIHN1Y2Nlc3MgaWYgdGhlIHRhcmdldCBkaXJlY3RvcnkgaXMgcmVhZC1vbmx5CmNoZWNrX3RhcmdldF9ybygpIHsKICAgIHRvdWNoICIke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfSIvLnJrZTItcm8tdGVzdCAmJiBybSAtcmYgIiR7SU5TVEFMTF9SS0UyX1RBUl9QUkVGSVh9Ii8ucmtlMi1yby10ZXN0CiAgICB0ZXN0ICQ/IC1uZSAwCn0KCgojIHNldHVwX2VudiBkZWZpbmVzIG5lZWRlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMuCnNldHVwX2VudigpIHsKICAgIFNUT1JBR0VfVVJMPSJodHRwczovL3JrZTItY2ktYnVpbGRzLnMzLmFtYXpvbmF3cy5jb20iCiAgICBJTlNUQUxMX1JLRTJfR0lUSFVCX1VSTD0iaHR0cHM6Ly9naXRodWIuY29tL3JhbmNoZXIvcmtlMiIKICAgIERFRkFVTFRfVEFSX1BSRUZJWD0iL3Vzci9sb2NhbCIKICAgICMgLS0tIGJhaWwgaWYgd2UgYXJlIG5vdCByb290IC0tLQogICAgaWYgWyAhICQoaWQgLXUpIC1lcSAwIF07IHRoZW4KICAgICAgICBmYXRhbCAiWW91IG5lZWQgdG8gYmUgcm9vdCB0byBwZXJmb3JtIHRoaXMgaW5zdGFsbCIKICAgIGZpCgogICAgIyAtLS0gbWFrZSBzdXJlIGluc3RhbGwgY2hhbm5lbCBoYXMgYSB2YWx1ZQogICAgaWYgWyAteiAiJHtJTlNUQUxMX1JLRTJfQ0hBTk5FTH0iIF07IHRoZW4KICAgICAgICBJTlNUQUxMX1JLRTJfQ0hBTk5FTD0ic3RhYmxlIgogICAgZmkKCiAgICAjIC0tLSBtYWtlIHN1cmUgaW5zdGFsbCB0eXBlIGhhcyBhIHZhbHVlCiAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9UWVBFfSIgXTsgdGhlbgogICAgICAgIElOU1RBTExfUktFMl9UWVBFPSIke0lOU1RBTExfUktFMl9FWEVDOi1zZXJ2ZXJ9IgogICAgZmkKCiAgICAjIC0tLSB1c2UgcnBtIGluc3RhbGwgbWV0aG9kIGlmIGF2YWlsYWJsZSBieSBkZWZhdWx0CiAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfSIgXSAmJiBbIC16ICIke0lOU1RBTExfUktFMl9DT01NSVR9IiBdICYmIFsgLXogIiR7SU5TVEFMTF9SS0UyX01FVEhPRH0iIF0gJiYgY29tbWFuZCAtdiB5dW0gPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgSU5TVEFMTF9SS0UyX01FVEhPRD0icnBtIgogICAgZmkKCiAgICAjIC0tLSBpbnN0YWxsIHRhcmJhbGwgdG8gL3Vzci9sb2NhbCBieSBkZWZhdWx0LCBleGNlcHQgaWYgL3Vzci9sb2NhbCBpcyBvbiBhIHNlcGFyYXRlIHBhcnRpdGlvbiBvciBpcyByZWFkLW9ubHkKICAgICMgLS0tIGluIHdoaWNoIGNhc2Ugd2UgZ28gaW50byAvb3B0L3JrZTIuCiAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfSIgXTsgdGhlbgogICAgICAgIElOU1RBTExfUktFMl9UQVJfUFJFRklYPSR7REVGQVVMVF9UQVJfUFJFRklYfQogICAgICAgIGlmIGNoZWNrX3RhcmdldF9tb3VudHBvaW50IHx8IGNoZWNrX3RhcmdldF9ybzsgdGhlbgogICAgICAgICAgICBJTlNUQUxMX1JLRTJfVEFSX1BSRUZJWD0iL29wdC9ya2UyIgogICAgICAgICAgICB3YXJuICIke0RFRkFVTFRfVEFSX1BSRUZJWH0gaXMgcmVhZC1vbmx5IG9yIGEgbW91bnQgcG9pbnQ7IGluc3RhbGxpbmcgdG8gJHtJTlNUQUxMX1JLRTJfVEFSX1BSRUZJWH0iCiAgICAgICAgZmkKICAgIGZpCgogICAgaWYgWyAteiAiJHtJTlNUQUxMX1JLRTJfQUdFTlRfSU1BR0VTX0RJUn0iIF07IHRoZW4KICAgICAgICBJTlNUQUxMX1JLRTJfQUdFTlRfSU1BR0VTX0RJUj0iL3Zhci9saWIvcmFuY2hlci9ya2UyL2FnZW50L2ltYWdlcyIKICAgIGZpCn0KCiMgY2hlY2tfbWV0aG9kX2NvbmZsaWN0IHdpbGwgZXhpdCB3aXRoIGFuIGVycm9yIGlmIHRoZSB1c2VyIGF0dGVtcHRzIHRvIGluc3RhbGwKIyB2aWEgdGFyIG1ldGhvZCBvbiBhIGhvc3Qgd2l0aCBleGlzdGluZyBSUE1zLgpjaGVja19tZXRob2RfY29uZmxpY3QoKSB7CiAgICAgLiAvZXRjL29zLXJlbGVhc2UKICAgIGNhc2UgJHtJTlNUQUxMX1JLRTJfTUVUSE9EfSBpbgogICAgeXVtIHwgcnBtIHwgZG5mKQogICAgICAgIGlmIFsgIiR7SURfTElLRSUlWyBdKn0iID0gInN1c2UiIF07IHRoZW4KICAgICAgICAgICAgaWYgWyAtZiAke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfS9iaW4vcmtlMiBdOyB0aGVuCiAgICAgICAgICAgICAgICBmYXRhbCAiQ2Fubm90IHBlcmZvcm0gJHtJTlNUQUxMX1JLRTJfTUVUSE9EOi1ycG19IGluc3RhbGwgb24gaG9zdCB3aXRoIGV4aXN0aW5nIHRhcmJhbGwgaW5zdGFsbGF0aW9uIC0gcGxlYXNlIHJ1biBya2UyLXVuaW5zdGFsbC5zaCBmaXJzdCIKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgICAgIHJldHVybgogICAgICAgIDs7CiAgICAqKQogICAgICAgIGlmIHJwbSAtcSBya2UyLWNvbW1vbiA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICAgICAgZmF0YWwgIkNhbm5vdCBwZXJmb3JtICR7SU5TVEFMTF9SS0UyX01FVEhPRDotdGFyfSBpbnN0YWxsIG9uIGhvc3Qgd2l0aCBleGlzdGluZyBSS0UyIFJQTXMgLSBwbGVhc2UgcnVuIHJrZTItdW5pbnN0YWxsLnNoIGZpcnN0IgogICAgICAgIGZpCiAgICAgICAgOzsKICAgIGVzYWMKfQoKIyBzZXR1cF9hcmNoIHNldCBhcmNoIGFuZCBzdWZmaXgsCiMgZmF0YWwgaWYgYXJjaGl0ZWN0dXJlIG5vdCBzdXBwb3J0ZWQuCnNldHVwX2FyY2goKSB7CiAgICBjYXNlICR7QVJDSDo9JCh1bmFtZSAtbSl9IGluCiAgICB4ODZfNjR8YW1kNjQpCiAgICAgICAgQVJDSD1hbWQ2NAogICAgICAgIFNVRkZJWD0kKHVuYW1lIC1zIHwgdHIgJ1s6dXBwZXI6XScgJ1s6bG93ZXI6XScpLSR7QVJDSH0KICAgICAgICA7OwogICAgYWFyY2g2NHxhcm02NCkKICAgICAgICBBUkNIPWFybTY0CiAgICAgICAgU1VGRklYPSQodW5hbWUgLXMgfCB0ciAnWzp1cHBlcjpdJyAnWzpsb3dlcjpdJyktJHtBUkNIfQogICAgICAgIDs7CiAgICBzMzkweCkKICAgICAgICBBUkNIPXMzOTB4CiAgICAgICAgU1VGRklYPSQodW5hbWUgLXMgfCB0ciAnWzp1cHBlcjpdJyAnWzpsb3dlcjpdJyktJHtBUkNIfQogICAgICAgIDs7CiAgICAqKQogICAgICAgIGZhdGFsICJ1bnN1cHBvcnRlZCBhcmNoaXRlY3R1cmUgJHtBUkNIfSIKICAgICAgICA7OwogICAgZXNhYwp9CgojIHZlcmlmeV9kb3dubG9hZGVyIHZlcmlmaWVzIGV4aXN0ZW5jZSBvZgojIG5ldHdvcmsgZG93bmxvYWRlciBleGVjdXRhYmxlLgp2ZXJpZnlfZG93bmxvYWRlcigpIHsKICAgIGNtZD0iJChjb21tYW5kIC12ICIkezF9IikiCiAgICBpZiBbIC16ICIke2NtZH0iIF07IHRoZW4KICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIGlmIFsgISAteCAiJHtjbWR9IiBdOyB0aGVuCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgIyBTZXQgdmVyaWZpZWQgZXhlY3V0YWJsZSBhcyBvdXIgZG93bmxvYWRlciBwcm9ncmFtIGFuZCByZXR1cm4gc3VjY2VzcwogICAgRE9XTkxPQURFUj0ke2NtZH0KICAgIHJldHVybiAwCn0KCiMgdmVyaWZ5X2ZhcG9saWN5ZCB2ZXJpZmllcyBleGlzdGVuY2Ugb2YKIyBmYXBvbGljeWQgYW5kIGZhZ2VucnVsZXMgZXhlY3V0YWJsZXMgYW5kIG1ha2Ugc3VyZSB0aGF0IGZhcG9saWN5ZCBzZXJ2aWNlIGlzIHJ1bm5pbmcuCnZlcmlmeV9mYXBvbGljeWQoKSB7CiAgICBjbWQ9IiQoY29tbWFuZCAtdiAiZmFwb2xpY3lkIikiCiAgICBpZiBbIC16ICIke2NtZH0iIF07IHRoZW4KICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIGNtZD0iJChjb21tYW5kIC12ICJmYWdlbnJ1bGVzIikiCiAgICBpZiBbIC16ICIke2NtZH0iIF07IHRoZW4KICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIHN5c3RlbWN0bCBpcy1hY3RpdmUgLS1xdWlldCBmYXBvbGljeWQgfHwgcmV0dXJuIDEKCiAgICByZXR1cm4gMAp9CgojIHNldHVwX3RtcCBjcmVhdGVzIGEgdGVtcG9yYXJ5IGRpcmVjdG9yeQojIGFuZCBjbGVhbnMgdXAgd2hlbiBkb25lLgpzZXR1cF90bXAoKSB7CiAgICBUTVBfRElSPSQobWt0ZW1wIC1kIC10IHJrZTItaW5zdGFsbC5YWFhYWFhYWFhYKQogICAgVE1QX0NIRUNLU1VNUz0ke1RNUF9ESVJ9L3JrZTIuY2hlY2tzdW1zCiAgICBUTVBfVEFSQkFMTD0ke1RNUF9ESVJ9L3JrZTIudGFyYmFsbAogICAgVE1QX0FJUkdBUF9DSEVDS1NVTVM9JHtUTVBfRElSfS9ya2UyLWltYWdlcy5jaGVja3N1bXMKICAgIFRNUF9BSVJHQVBfVEFSQkFMTD0ke1RNUF9ESVJ9L3JrZTItaW1hZ2VzLnRhcmJhbGwKICAgIGNsZWFudXAoKSB7CiAgICAgICAgY29kZT0kPwogICAgICAgIHNldCArZQogICAgICAgIHRyYXAgLSBFWElUCiAgICAgICAgcm0gLXJmICIke1RNUF9ESVJ9IgogICAgICAgIGV4aXQgJGNvZGUKICAgIH0KICAgIHRyYXAgY2xlYW51cCBJTlQgRVhJVAp9CgojIC0tLSB1c2UgZGVzaXJlZCBya2UyIHZlcnNpb24gaWYgZGVmaW5lZCBvciBmaW5kIHZlcnNpb24gZnJvbSBjaGFubmVsIC0tLQpnZXRfcmVsZWFzZV92ZXJzaW9uKCkgewogICAgaWYgWyAtbiAiJHtJTlNUQUxMX1JLRTJfQ09NTUlUfSIgXTsgdGhlbgogICAgICAgIHZlcnNpb249ImNvbW1pdCAke0lOU1RBTExfUktFMl9DT01NSVR9IgogICAgZWxpZiBbIC1uICIke0lOU1RBTExfUktFMl9WRVJTSU9OfSIgXTsgdGhlbgogICAgICAgIHZlcnNpb249JHtJTlNUQUxMX1JLRTJfVkVSU0lPTn0KICAgIGVsc2UKICAgICAgICBpbmZvICJmaW5kaW5nIHJlbGVhc2UgZm9yIGNoYW5uZWwgJHtJTlNUQUxMX1JLRTJfQ0hBTk5FTH0iCiAgICAgICAgSU5TVEFMTF9SS0UyX0NIQU5ORUxfVVJMPSR7SU5TVEFMTF9SS0UyX0NIQU5ORUxfVVJMOi0naHR0cHM6Ly91cGRhdGUucmtlMi5pby92MS1yZWxlYXNlL2NoYW5uZWxzJ30KICAgICAgICB2ZXJzaW9uX3VybD0iJHtJTlNUQUxMX1JLRTJfQ0hBTk5FTF9VUkx9LyR7SU5TVEFMTF9SS0UyX0NIQU5ORUx9IgogICAgICAgIGNhc2UgJHtET1dOTE9BREVSfSBpbgogICAgICAgICpjdXJsKQogICAgICAgICAgICB2ZXJzaW9uPSQoJHtET1dOTE9BREVSfSAtdyAiJXt1cmxfZWZmZWN0aXZlfSIgLUwgLXMgLVMgIiR7dmVyc2lvbl91cmx9IiAtbyAvZGV2L251bGwgfCBzZWQgLWUgJ3N8LiovfHwnKQogICAgICAgICAgICA7OwogICAgICAgICp3Z2V0KQogICAgICAgICAgICB2ZXJzaW9uPSQoJHtET1dOTE9BREVSfSAtU3FPIC9kZXYvbnVsbCAiJHt2ZXJzaW9uX3VybH0iIDI+JjEgfCBncmVwIC1pIExvY2F0aW9uIHwgc2VkIC1lICdzfC4qL3x8JykKICAgICAgICAgICAgOzsKICAgICAgICAqKQogICAgICAgICAgICBmYXRhbCAiVW5zdXBwb3J0ZWQgZG93bmxvYWRlciBleGVjdXRhYmxlICcke0RPV05MT0FERVJ9JyIKICAgICAgICAgICAgOzsKICAgICAgICBlc2FjCiAgICAgICAgSU5TVEFMTF9SS0UyX1ZFUlNJT049IiR7dmVyc2lvbn0iCiAgICBmaQp9CgojIGNoZWNrX2Rvd25sb2FkIHBlcmZvcm1zIGEgSEVBRCByZXF1ZXN0IHRvIHNlZSBpZiBhIGZpbGUgZXhpc3RzIGF0IGEgZ2l2ZW4gdXJsCmNoZWNrX2Rvd25sb2FkKCkgewogICAgY2FzZSAke0RPV05MT0FERVJ9IGluCiAgICAqY3VybCkKICAgICAgICBjdXJsIC1vICIvZGV2L251bGwiIC1mc0xJIC1YIEhFQUQgIiQxIgogICAgICAgIDs7CiAgICAqd2dldCkKICAgICAgICB3Z2V0IC1xIC0tc3BpZGVyICIkMSIKICAgICAgICA7OwogICAgKikKICAgICAgICBmYXRhbCAiZG93bmxvYWRlciBleGVjdXRhYmxlIG5vdCBzdXBwb3J0ZWQ6ICcke0RPV05MT0FERVJ9JyIKICAgICAgICA7OwogICAgZXNhYwp9CgojIGRvd25sb2FkIGRvd25sb2FkcyBhIGZpbGUgZnJvbSBhIHVybCB1c2luZyBlaXRoZXIgY3VybCBvciB3Z2V0CmRvd25sb2FkKCkgewogICAgaWYgWyAkIyAtbmUgMiBdOyB0aGVuCiAgICAgICAgZmF0YWwgImRvd25sb2FkIG5lZWRzIGV4YWN0bHkgMiBhcmd1bWVudHMiCiAgICBmaQoKICAgIGNhc2UgJHtET1dOTE9BREVSfSBpbgogICAgKmN1cmwpCiAgICAgICAgY3VybCAtbyAiJDEiIC1mc1NMICIkMiIKICAgICAgICA7OwogICAgKndnZXQpCiAgICAgICAgd2dldCAtcU8gIiQxIiAiJDIiCiAgICAgICAgOzsKICAgICopCiAgICAgICAgZmF0YWwgImRvd25sb2FkZXIgZXhlY3V0YWJsZSBub3Qgc3VwcG9ydGVkOiAnJHtET1dOTE9BREVSfSciCiAgICAgICAgOzsKICAgIGVzYWMKCiAgICAjIEFib3J0IGlmIGRvd25sb2FkIGNvbW1hbmQgZmFpbGVkCiAgICBpZiBbICQ/IC1uZSAwIF07IHRoZW4KICAgICAgICBmYXRhbCAiZG93bmxvYWQgZmFpbGVkIgogICAgZmkKfQoKIyBkb3dubG9hZF9jaGVja3N1bXMgZG93bmxvYWRzIGhhc2ggZnJvbSBnaXRodWIgdXJsLgpkb3dubG9hZF9jaGVja3N1bXMoKSB7CiAgICBpZiBbIC1uICIke0lOU1RBTExfUktFMl9DT01NSVR9IiBdOyB0aGVuCiAgICAgICAgQ0hFQ0tTVU1TX1VSTD0ke1NUT1JBR0VfVVJMfS9ya2UyLiR7U1VGRklYfS0ke0lOU1RBTExfUktFMl9DT01NSVR9LnRhci5nei5zaGEyNTZzdW0KICAgIGVsc2UKICAgICAgICBDSEVDS1NVTVNfVVJMPSR7SU5TVEFMTF9SS0UyX0dJVEhVQl9VUkx9L3JlbGVhc2VzL2Rvd25sb2FkLyR7SU5TVEFMTF9SS0UyX1ZFUlNJT059L3NoYTI1NnN1bS0ke0FSQ0h9LnR4dAogICAgZmkKICAgIGluZm8gImRvd25sb2FkaW5nIGNoZWNrc3VtcyBhdCAke0NIRUNLU1VNU19VUkx9IgogICAgZG93bmxvYWQgIiR7VE1QX0NIRUNLU1VNU30iICIke0NIRUNLU1VNU19VUkx9IgogICAgQ0hFQ0tTVU1fRVhQRUNURUQ9JChncmVwICJya2UyLiR7U1VGRklYfS50YXIuZ3oiICIke1RNUF9DSEVDS1NVTVN9IiB8IGF3ayAne3ByaW50ICQxfScpCn0KCiMgZG93bmxvYWRfdGFyYmFsbCBkb3dubG9hZHMgYmluYXJ5IGZyb20gZ2l0aHViIHVybC4KZG93bmxvYWRfdGFyYmFsbCgpIHsKICAgIGlmIFsgLW4gIiR7SU5TVEFMTF9SS0UyX0NPTU1JVH0iIF07IHRoZW4KICAgICAgICBUQVJCQUxMX1VSTD0ke1NUT1JBR0VfVVJMfS9ya2UyLiR7U1VGRklYfS0ke0lOU1RBTExfUktFMl9DT01NSVR9LnRhci5negogICAgZWxzZQogICAgICAgIFRBUkJBTExfVVJMPSR7SU5TVEFMTF9SS0UyX0dJVEhVQl9VUkx9L3JlbGVhc2VzL2Rvd25sb2FkLyR7SU5TVEFMTF9SS0UyX1ZFUlNJT059L3JrZTIuJHtTVUZGSVh9LnRhci5negogICAgZmkKICAgIGluZm8gImRvd25sb2FkaW5nIHRhcmJhbGwgYXQgJHtUQVJCQUxMX1VSTH0iCiAgICBkb3dubG9hZCAiJHtUTVBfVEFSQkFMTH0iICIke1RBUkJBTExfVVJMfSIKfQoKIyBkb3dubG9hZF9kZXZfcnBtIGRvd25sb2FkcyBkZXYgcnBtIGZyb20gcmVtb3RlIHJlcG9zaXRvcnkKZG93bmxvYWRfZGV2X3JwbSgpIHsKICAgIGlmIFsgLXogIiR7SU5TVEFMTF9SS0UyX0NPTU1JVH0iIF07IHRoZW4KICAgICAgICBmYXRhbCAnRGV2ZWxvcG1lbnQgcnBtIHJlcXVpcmVzIGEgY29tbWl0IGhhc2gnCiAgICBmaQoKICAgIERFU1Q9IiR7MX0iCiAgICBSUE1fRklMRT0kKGJhc2VuYW1lICIke0RFU1R9IikKICAgIFJQTV9VUkw9IiR7U1RPUkFHRV9VUkx9LyR7UlBNX0ZJTEV9IgoKICAgIGluZm8gImRvd25sb2FkaW5nIHJwbSBhdCAke1JQTV9VUkx9IgogICAgZG93bmxvYWQgIiR7REVTVH0iICIke1JQTV9VUkx9Igp9CgojIHN0YWdlX2xvY2FsX2NoZWNrc3VtcyBzdGFnZXMgdGhlIGxvY2FsIGNoZWNrc3VtIGhhc2ggZm9yIHZhbGlkYXRpb24uCnN0YWdlX2xvY2FsX2NoZWNrc3VtcygpIHsKICAgIGluZm8gInN0YWdpbmcgbG9jYWwgY2hlY2tzdW1zIGZyb20gJHtJTlNUQUxMX1JLRTJfQVJUSUZBQ1RfUEFUSH0vc2hhMjU2c3VtLSR7QVJDSH0udHh0IgogICAgY3AgLWYgIiR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3NoYTI1NnN1bS0ke0FSQ0h9LnR4dCIgIiR7VE1QX0NIRUNLU1VNU30iCiAgICBDSEVDS1NVTV9FWFBFQ1RFRD0kKGdyZXAgInJrZTIuJHtTVUZGSVh9LnRhci5neiIgIiR7VE1QX0NIRUNLU1VNU30iIHwgYXdrICd7cHJpbnQgJDF9JykKICAgIGlmIFsgLWYgIiR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS50YXIuenN0IiBdOyB0aGVuCiAgICAgICAgQUlSR0FQX0NIRUNLU1VNX0VYUEVDVEVEPSQoZ3JlcCAicmtlMi1pbWFnZXMuJHtTVUZGSVh9LnRhci56c3QiICIke1RNUF9DSEVDS1NVTVN9IiB8IGF3ayAne3ByaW50ICQxfScpCiAgICBlbGlmIFsgLWYgIiR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS50YXIuZ3oiIF07IHRoZW4KICAgICAgICBBSVJHQVBfQ0hFQ0tTVU1fRVhQRUNURUQ9JChncmVwICJya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLmd6IiAiJHtUTVBfQ0hFQ0tTVU1TfSIgfCBhd2sgJ3twcmludCAkMX0nKQogICAgZmkKfQoKIyBzdGFnZV9sb2NhbF90YXJiYWxsIHN0YWdlcyB0aGUgbG9jYWwgdGFyYmFsbC4Kc3RhZ2VfbG9jYWxfdGFyYmFsbCgpIHsKICAgIGluZm8gInN0YWdpbmcgdGFyYmFsbCBmcm9tICR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3JrZTIuJHtTVUZGSVh9LnRhci5neiIKICAgIGNwIC1mICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfS9ya2UyLiR7U1VGRklYfS50YXIuZ3oiICIke1RNUF9UQVJCQUxMfSIKfQoKIyBzdGFnZV9sb2NhbF9haXJnYXBfdGFyYmFsbCBzdGFnZXMgdGhlIGxvY2FsIGNoZWNrc3VtIGhhc2ggZm9yIHZhbGlkYXRpb24uCnN0YWdlX2xvY2FsX2FpcmdhcF90YXJiYWxsKCkgewogICAgaWYgWyAtZiAiJHtJTlNUQUxMX1JLRTJfQVJUSUZBQ1RfUEFUSH0vcmtlMi1pbWFnZXMuJHtTVUZGSVh9LnRhci56c3QiIF07IHRoZW4KICAgICAgICBpbmZvICJzdGFnaW5nIHpzdCBhaXJnYXAgaW1hZ2UgdGFyYmFsbCBmcm9tICR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS50YXIuenN0IgogICAgICAgIGNwIC1mICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLnpzdCIgIiR7VE1QX0FJUkdBUF9UQVJCQUxMfSIKICAgICAgICBBSVJHQVBfVEFSQkFMTF9GT1JNQVQ9enN0CiAgICBlbGlmIFsgLWYgIiR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS50YXIuZ3oiIF07IHRoZW4KICAgICAgICBpbmZvICJzdGFnaW5nIGd6aXAgYWlyZ2FwIGltYWdlIHRhcmJhbGwgZnJvbSAke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLmd6IgogICAgICAgIGNwIC1mICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLmd6IiAiJHtUTVBfQUlSR0FQX1RBUkJBTEx9IgogICAgICAgIEFJUkdBUF9UQVJCQUxMX0ZPUk1BVD1negogICAgZmkKfQoKIyB2ZXJpZnlfdGFyYmFsbCB2ZXJpZmllcyB0aGUgZG93bmxvYWRlZCBpbnN0YWxsZXIgY2hlY2tzdW0uCnZlcmlmeV90YXJiYWxsKCkgewogICAgaW5mbyAidmVyaWZ5aW5nIHRhcmJhbGwiCiAgICBDSEVDS1NVTV9BQ1RVQUw9JChzaGEyNTZzdW0gIiR7VE1QX1RBUkJBTEx9IiB8IGF3ayAne3ByaW50ICQxfScpCiAgICBpZiBbICIke0NIRUNLU1VNX0VYUEVDVEVEfSIgIT0gIiR7Q0hFQ0tTVU1fQUNUVUFMfSIgXTsgdGhlbgogICAgICAgIGZhdGFsICJkb3dubG9hZCBzaGEyNTYgZG9lcyBub3QgbWF0Y2ggJHtDSEVDS1NVTV9FWFBFQ1RFRH0sIGdvdCAke0NIRUNLU1VNX0FDVFVBTH0iCiAgICBmaQp9CgojIHVucGFja190YXJiYWxsIGV4dHJhY3RzIHRoZSB0YXJiYWxsLCBjb3JyZWN0aW5nIHBhdGhzIGFuZCBtb3Zpbmcgc3lzdGVtZCB1bml0cyBhcyBuZWNlc3NhcnkKdW5wYWNrX3RhcmJhbGwoKSB7CiAgICBpbmZvICJ1bnBhY2tpbmcgdGFyYmFsbCBmaWxlIHRvICR7SU5TVEFMTF9SS0UyX1RBUl9QUkVGSVh9IgogICAgbWtkaXIgLXAgJHtJTlNUQUxMX1JLRTJfVEFSX1BSRUZJWH0KICAgIHRhciB4emYgIiR7VE1QX1RBUkJBTEx9IiAtQyAiJHtJTlNUQUxMX1JLRTJfVEFSX1BSRUZJWH0iCiAgICBpZiBbICIke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfSIgIT0gIiR7REVGQVVMVF9UQVJfUFJFRklYfSIgXTsgdGhlbgogICAgICAgIGluZm8gInVwZGF0aW5nIHRhcmJhbGwgY29udGVudHMgdG8gcmVmbGVjdCBpbnN0YWxsIHBhdGgiCiAgICAgICAgc2VkIC1pICJzfCR7REVGQVVMVF9UQVJfUFJFRklYfXwke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfXwiICR7SU5TVEFMTF9SS0UyX1RBUl9QUkVGSVh9L2xpYi9zeXN0ZW1kL3N5c3RlbS9ya2UyLSouc2VydmljZSAke0lOU1RBTExfUktFMl9UQVJfUFJFRklYfS9iaW4vcmtlMi11bmluc3RhbGwuc2gKICAgICAgICBpbmZvICJtb3Zpbmcgc3lzdGVtZCB1bml0cyB0byAvZXRjL3N5c3RlbWQvc3lzdGVtIgogICAgICAgIG12IC1mICR7SU5TVEFMTF9SS0UyX1RBUl9QUkVGSVh9L2xpYi9zeXN0ZW1kL3N5c3RlbS9ya2UyLSouc2VydmljZSAvZXRjL3N5c3RlbWQvc3lzdGVtLwogICAgICAgIGluZm8gImluc3RhbGwgY29tcGxldGU7IHlvdSBtYXkgd2FudCB0byBydW46ICBleHBvcnQgUEFUSD1cJFBBVEg6JHtJTlNUQUxMX1JLRTJfVEFSX1BSRUZJWH0vYmluIgogICAgZmkKfQoKIyBkb3dubG9hZF9haXJnYXBfY2hlY2tzdW1zIGRvd25sb2FkcyB0aGUgY2hlY2tzdW0gZmlsZSBmb3IgdGhlIGFpcmdhcCBpbWFnZSB0YXJiYWxsCiMgYW5kIHByZXBhcmVzIHRoZSBjaGVja3N1bSB2YWx1ZSBmb3IgbGF0ZXIgdmFsaWRhdGlvbi4KZG93bmxvYWRfYWlyZ2FwX2NoZWNrc3VtcygpIHsKICAgIGlmIFsgLXogIiR7SU5TVEFMTF9SS0UyX0NPTU1JVH0iIF07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCiAgICBBSVJHQVBfQ0hFQ0tTVU1TX1VSTD0ke1NUT1JBR0VfVVJMfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0tJHtJTlNUQUxMX1JLRTJfQ09NTUlUfS50YXIuenN0LnNoYTI1NnN1bQogICAgIyB0cnkgZm9yIHpzdCBmaXJzdDsgaWYgdGhhdCBmYWlscyB1c2UgZ3ogZm9yIG9sZGVyIHJlbGVhc2UgYnJhbmNoZXMKICAgIGlmICEgY2hlY2tfZG93bmxvYWQgIiR7QUlSR0FQX0NIRUNLU1VNU19VUkx9IjsgdGhlbgogICAgICAgIEFJUkdBUF9DSEVDS1NVTVNfVVJMPSR7U1RPUkFHRV9VUkx9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS0ke0lOU1RBTExfUktFMl9DT01NSVR9LnRhci5nei5zaGEyNTZzdW0KICAgIGZpCiAgICBpbmZvICJkb3dubG9hZGluZyBhaXJnYXAgY2hlY2tzdW1zIGF0ICR7QUlSR0FQX0NIRUNLU1VNU19VUkx9IgogICAgZG93bmxvYWQgIiR7VE1QX0FJUkdBUF9DSEVDS1NVTVN9IiAiJHtBSVJHQVBfQ0hFQ0tTVU1TX1VSTH0iCiAgICBBSVJHQVBfQ0hFQ0tTVU1fRVhQRUNURUQ9JChncmVwICJya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyIiAiJHtUTVBfQUlSR0FQX0NIRUNLU1VNU30iIHwgYXdrICd7cHJpbnQgJDF9JykKfQoKIyBkb3dubG9hZF9haXJnYXBfdGFyYmFsbCBkb3dubG9hZHMgdGhlIGFpcmdhcCBpbWFnZSB0YXJiYWxsLgpkb3dubG9hZF9haXJnYXBfdGFyYmFsbCgpIHsKICAgIGlmIFsgLXogIiR7SU5TVEFMTF9SS0UyX0NPTU1JVH0iIF07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCiAgICBBSVJHQVBfVEFSQkFMTF9VUkw9JHtTVE9SQUdFX1VSTH0vcmtlMi1pbWFnZXMuJHtTVUZGSVh9LSR7SU5TVEFMTF9SS0UyX0NPTU1JVH0udGFyLnpzdAogICAgIyB0cnkgZm9yIHpzdCBmaXJzdDsgaWYgdGhhdCBmYWlscyB1c2UgZ3ogZm9yIG9sZGVyIHJlbGVhc2UgYnJhbmNoZXMKICAgIGlmICEgY2hlY2tfZG93bmxvYWQgIiR7QUlSR0FQX1RBUkJBTExfVVJMfSI7IHRoZW4KICAgICAgICBBSVJHQVBfVEFSQkFMTF9VUkw9JHtTVE9SQUdFX1VSTH0vcmtlMi1pbWFnZXMuJHtTVUZGSVh9LSR7SU5TVEFMTF9SS0UyX0NPTU1JVH0udGFyLmd6CiAgICBmaQogICAgaW5mbyAiZG93bmxvYWRpbmcgYWlyZ2FwIHRhcmJhbGwgYXQgJHtBSVJHQVBfVEFSQkFMTF9VUkx9IgogICAgZG93bmxvYWQgIiR7VE1QX0FJUkdBUF9UQVJCQUxMfSIgIiR7QUlSR0FQX1RBUkJBTExfVVJMfSIKfQoKIyB2ZXJpZnlfYWlyZ2FwX3RhcmJhbGwgY29tcGFyZXMgdGhlIGFpcmdhcCBpbWFnZSB0YXJiYWxsIGNoZWNrc3VtIHRvIHRoZSB2YWx1ZQojIGNhbGN1bGF0ZWQgYnkgQ0kgd2hlbiB0aGUgZmlsZSB3YXMgdXBsb2FkZWQuCnZlcmlmeV9haXJnYXBfdGFyYmFsbCgpIHsKICAgIGlmIFsgLXogIiR7QUlSR0FQX0NIRUNLU1VNX0VYUEVDVEVEfSIgXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKICAgIGluZm8gInZlcmlmeWluZyBhaXJnYXAgdGFyYmFsbCIKICAgIEFJUkdBUF9DSEVDS1NVTV9BQ1RVQUw9JChzaGEyNTZzdW0gIiR7VE1QX0FJUkdBUF9UQVJCQUxMfSIgfCBhd2sgJ3twcmludCAkMX0nKQogICAgaWYgWyAiJHtBSVJHQVBfQ0hFQ0tTVU1fRVhQRUNURUR9IiAhPSAiJHtBSVJHQVBfQ0hFQ0tTVU1fQUNUVUFMfSIgXTsgdGhlbgogICAgICAgIGZhdGFsICJkb3dubG9hZCBzaGEyNTYgZG9lcyBub3QgbWF0Y2ggJHtBSVJHQVBfQ0hFQ0tTVU1fRVhQRUNURUR9LCBnb3QgJHtBSVJHQVBfQ0hFQ0tTVU1fQUNUVUFMfSIKICAgIGZpCn0KCiMgaW5zdGFsbF9haXJnYXBfdGFyYmFsbCBtb3ZlcyB0aGUgYWlyZ2FwIGltYWdlIHRhcmJhbGwgaW50byBwbGFjZS4KaW5zdGFsbF9haXJnYXBfdGFyYmFsbCgpIHsKICAgIGlmIFsgLXogIiR7QUlSR0FQX0NIRUNLU1VNX0VYUEVDVEVEfSIgXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKICAgIG1rZGlyIC1wICIke0lOU1RBTExfUktFMl9BR0VOVF9JTUFHRVNfRElSfSIKICAgICMgcmVsZWFzZXMgdGhhdCBwcm92aWRlIHpzdCBhcnRpZmFjdHMgY2FuIHJlYWQgZnJvbSB0aGUgY29tcHJlc3NlZCBhcmNoaXZlOyBvbGRlciByZWxlYXNlcwogICAgIyB0aGF0IHByb2R1Y2Ugb25seSBnemlwIGFydGlmYWN0cyBuZWVkIHRvIGhhdmUgdGhlIHRhcmJhbGwgZGVjb21wcmVzc2VkIGFoZWFkIG9mIHRpbWUKICAgIGlmIGdyZXAgLXNxRiAnLnRhci56c3QnICIke1RNUF9BSVJHQVBfQ0hFQ0tTVU1TfSIgfHwgWyAiJHtBSVJHQVBfVEFSQkFMTF9GT1JNQVR9IiA9ICJ6c3QiIF07IHRoZW4KICAgICAgICBpbmZvICJpbnN0YWxsaW5nIGFpcmdhcCB0YXJiYWxsIHRvICR7SU5TVEFMTF9SS0UyX0FHRU5UX0lNQUdFU19ESVJ9IgogICAgICAgIG12IC1mICIke1RNUF9BSVJHQVBfVEFSQkFMTH0iICIke0lOU1RBTExfUktFMl9BR0VOVF9JTUFHRVNfRElSfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLnpzdCIKICAgIGVsc2UKICAgICAgICBpbmZvICJkZWNvbXByZXNzaW5nIGFpcmdhcCB0YXJiYWxsIHRvICR7SU5TVEFMTF9SS0UyX0FHRU5UX0lNQUdFU19ESVJ9IgogICAgICAgIGd6aXAgLWRjICIke1RNUF9BSVJHQVBfVEFSQkFMTH0iID4gIiR7SU5TVEFMTF9SS0UyX0FHRU5UX0lNQUdFU19ESVJ9L3JrZTItaW1hZ2VzLiR7U1VGRklYfS50YXIiCiAgICBmaQogICAgIyBTZWFyY2ggZm9yIGFuZCBpbnN0YWxsIGFkZGl0aW9uYWwgcmtlMiBpbWFnZXMKICAgIGZvciBJTUFHRSBpbiAiJHtJTlNUQUxMX1JLRTJfQVJUSUZBQ1RfUEFUSH0iL3JrZTItaW1hZ2VzLSouIiR7U1VGRklYfSIqOyBkbyAKICAgICAgICBpZiBbIC1mICIke0lNQUdFfSIgXTsgdGhlbgogICAgICAgICAgICBpbmZvICJJbnN0YWxsaW5nIGFpcmdhcCBpbWFnZSBmcm9tICR7SU1BR0V9IgogICAgICAgICAgICBjcCAiJHtJTUFHRX0iICIke0lOU1RBTExfUktFMl9BR0VOVF9JTUFHRVNfRElSfSIKICAgICAgICBmaQogICAgZG9uZQp9CgojIGluc3RhbGxfZGV2X3JwbSBvcmNoZXN0cmF0ZXMgdGhlIGluc3RhbGxhdGlvbiBvZiBSS0UyIHVuc2lnbmVkIGRldmVsb3BtZW50IHJwbXMKaW5zdGFsbF9kZXZfcnBtKCkgewogICAgcnBtX2luc3RhbGxlcj0iJHsxOi15dW19IgogICAgZGlzdHJvPSIkezI6LWNlbnRvczd9IgoKICAgIFsgLXogIiR7VE1QX0RJUn0iIF0gJiYgc2V0dXBfdG1wCgogICAgY2FzZSAiJHtycG1faW5zdGFsbGVyfSIgaW4KICAgICAgICAqenlwcGVyKikKICAgICAgICAgICAgJHtycG1faW5zdGFsbGVyfSBpbnN0YWxsIC0tYWxsb3ctdW5zaWduZWQtcnBtIC15IFwKICAgICAgICAgICAgICAgICIke1NUT1JBR0VfVVJMfS9ya2UyLWNvbW1vbi0ke0lOU1RBTExfUktFMl9DT01NSVR9LiR7ZGlzdHJvfS5ycG0iIFwKICAgICAgICAgICAgICAgICIke1NUT1JBR0VfVVJMfS9ya2UyLSR7SU5TVEFMTF9SS0UyX1RZUEV9LSR7SU5TVEFMTF9SS0UyX0NPTU1JVH0uJHtkaXN0cm99LnJwbSIKICAgICAgICAgICAgOzsKICAgICAgICAqKQogICAgICAgICAgICBkb3dubG9hZF9kZXZfcnBtICIke1RNUF9ESVJ9L3JrZTItY29tbW9uLSR7SU5TVEFMTF9SS0UyX0NPTU1JVH0uJHtkaXN0cm99LnJwbSIKICAgICAgICAgICAgZG93bmxvYWRfZGV2X3JwbSAiJHtUTVBfRElSfS9ya2UyLSR7SU5TVEFMTF9SS0UyX1RZUEV9LSR7SU5TVEFMTF9SS0UyX0NPTU1JVH0uJHtkaXN0cm99LnJwbSIKICAgICAgICAgICAgJHtycG1faW5zdGFsbGVyfSBpbnN0YWxsIC15ICAiJHtUTVBfRElSfSIvKi5ycG0KICAgICAgICAgICAgOzsKICAgIGVzYWMKCiAgICBpZiBbIC1mICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfS9ya2UyLWltYWdlcy4ke1NVRkZJWH0udGFyLnpzdCIgXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKCiAgICBkb3dubG9hZF9haXJnYXBfY2hlY2tzdW1zCiAgICBkb3dubG9hZF9haXJnYXBfdGFyYmFsbAogICAgdmVyaWZ5X2FpcmdhcF90YXJiYWxsCiAgICBpbnN0YWxsX2FpcmdhcF90YXJiYWxsCn0KCiMgZG9faW5zdGFsbF9ycG0gYnVpbGRzIGEgeXVtIHJlcG8gY29uZmlnIGZyb20gdGhlIGNoYW5uZWwgYW5kIHZlcnNpb24gdG8gYmUgaW5zdGFsbGVkLAojIGFuZCBjYWxscyB5dW0gdG8gaW5zdGFsbCB0aGUgcmVxdWlyZWQgcGFja2FnZXMuCmRvX2luc3RhbGxfcnBtKCkgewogICAgLiAvZXRjL29zLXJlbGVhc2UKICAgIGlmIFsgLXIgL2V0Yy9yZWRoYXQtcmVsZWFzZSBdIHx8IFsgLXIgL2V0Yy9jZW50b3MtcmVsZWFzZSBdIHx8IFsgLXIgL2V0Yy9vcmFjbGUtcmVsZWFzZSBdIHx8IFsgLXIgL2V0Yy9zeXN0ZW0tcmVsZWFzZSBdIHx8IFsgIiR7SURfTElLRSUlWyBdKn0iID0gInN1c2UiICBdOyB0aGVuCiAgICAgICAgcmVwb2Rpcj0vZXRjL3l1bS5yZXBvcy5kCiAgICAgICAgaWYgWyAtZCAvZXRjL3p5cHAvcmVwb3MuZCBdOyB0aGVuCiAgICAgICAgICAgIHJlcG9kaXI9L2V0Yy96eXBwL3JlcG9zLmQKICAgICAgICBmaQogICAgICAgIGlmIFsgIiR7SURfTElLRSUlWyBdKn0iID0gInN1c2UiIF07IHRoZW4KICAgICAgICAgICAgIyBjcmVhdGUgdGhlIC92YXIvbGliL3JwbS1zdGF0ZSBpbiBTTEUgc3lzdGVtcyB0byBmaXggdGhlIHByZWluIHNlbGludXggbWFjcm8KICAgICAgICAgICAgaWYgWyAiJHtUUkFOU0FDVElPTkFMX1VQREFURT1mYWxzZX0iICE9ICJ0cnVlIiBdICYmIFsgLXggL3Vzci9zYmluL3RyYW5zYWN0aW9uYWwtdXBkYXRlIF07IHRoZW4KICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uYWxfdXBkYXRlX3J1bj0idHJhbnNhY3Rpb25hbC11cGRhdGUgLS1uby1zZWxmdXBkYXRlIC1kIHJ1biIKICAgICAgICAgICAgZmkKICAgICAgICAgICAgJHt0cmFuc2FjdGlvbmFsX3VwZGF0ZV9ydW59IG1rZGlyIC1wIC92YXIvbGliL3JwbS1zdGF0ZQogICAgICAgICAgICAjIGNvbmZpZ3VyZSBpbmZpeCBhbmQgcnBtX2luc3RhbGxlcgogICAgICAgICAgICBycG1fc2l0ZV9pbmZpeD1taWNyb29zCiAgICAgICAgICAgIGlmIFsgIiR7VkFSSUFOVF9JRDotfSIgPSBzbGUtbWljcm8gXSB8fCBbICIke0lEOi19IiA9IHNsZS1taWNybyBdOyB0aGVuCiAgICAgICAgICAgICAgICBycG1fc2l0ZV9pbmZpeD1zbGVtaWNybwogICAgICAgICAgICAgICAgcGFja2FnZV9pbnN0YWxsZXI9enlwcGVyCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIHJwbV9pbnN0YWxsZXI9Inp5cHBlciAtLWdwZy1hdXRvLWltcG9ydC1rZXlzIgogICAgICAgICAgICBpZiBbICIke1RSQU5TQUNUSU9OQUxfVVBEQVRFPWZhbHNlfSIgIT0gInRydWUiIF0gJiYgWyAteCAvdXNyL3NiaW4vdHJhbnNhY3Rpb25hbC11cGRhdGUgXTsgdGhlbgogICAgICAgICAgICAgICAgcnBtX2luc3RhbGxlcj0idHJhbnNhY3Rpb25hbC11cGRhdGUgLS1uby1zZWxmdXBkYXRlIC1kIHJ1biAke3JwbV9pbnN0YWxsZXJ9IgogICAgICAgICAgICBmaQogICAgICAgIGVsc2UKICAgICAgICAgICAgbWFqX3Zlcj0kKGVjaG8gIiRWRVJTSU9OX0lEIiB8IHNlZCAtRSAtZSAicy9eKFswLTldKylcLj9bMC05XSokL1wxLyIpCiAgICAgICAgICAgIGNhc2UgJHttYWpfdmVyfSBpbgogICAgICAgICAgICAgICAgN3w4fDkpCiAgICAgICAgICAgICAgICAgICAgOgogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICAyMDIzKSAjIGRldGVjdCBhbWF6b24gbGludXggMjAyMyBkaXN0cm8KICAgICAgICAgICAgICAgICAgICBtYWpfdmVyPSI4IgogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICAqKSAjIHNldCBkZWZhdWx0IGRpc3RybyB0byBjZW50b3MgNywgZm9yIGVkZ2UgY2FzZXMgc3VjaCBhcyBmZWRvcmEKICAgICAgICAgICAgICAgICAgICBtYWpfdmVyPSI3IgogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgIGVzYWMKICAgICAgICAgICAgcnBtX3NpdGVfaW5maXg9Y2VudG9zLyR7bWFqX3Zlcn0KICAgICAgICAgICAgcnBtX2luc3RhbGxlcj0ieXVtIgogICAgICAgIGZpCgogICAgZmkKICAgIGNhc2UgIiR7SU5TVEFMTF9SS0UyX0NIQU5ORUx9IiBpbgogICAgICAgIHYqLiopCiAgICAgICAgICAgICMgV2UgYXJlIG9wZXJhdGluZyB3aXRoIGEgdmVyc2lvbi1iYXNlZCBjaGFubmVsLCBzbyB3ZSBzaG91bGQgcGFyc2Ugb3VyIHZlcnNpb24gb3V0CiAgICAgICAgICAgIHJrZTJfbWFqbWluPSQoZWNobyAiJHtJTlNUQUxMX1JLRTJfQ0hBTk5FTH0iIHwgc2VkIC1FIC1lICJzL152KFswLTldK1wuWzAtOV0rKS4qL1wxLyIpCiAgICAgICAgICAgIHJrZTJfcnBtX2NoYW5uZWw9JChlY2hvICIke0lOU1RBTExfUktFMl9DSEFOTkVMfSIgfCBzZWQgLUUgLWUgInMvXnZbMC05XStcLlswLTldKy0oLiopL1wxLyIpCiAgICAgICAgICAgICMgSWYgb3VyIHJlZ2V4IGZhaWxzIHRvIGNhcHR1cmUgYSAic2FuZSIgY2hhbm5lbCBvdXQgb2YgdGhlIHNwZWNpZmllZCBjaGFubmVsLCBmYWxsIGJhY2sgdG8gYHN0YWJsZWAKICAgICAgICAgICAgaWYgWyAiJHtya2UyX3JwbV9jaGFubmVsfSIgPSAke0lOU1RBTExfUktFMl9DSEFOTkVMfSBdOyB0aGVuCiAgICAgICAgICAgICAgICBpbmZvICJ1c2luZyBzdGFibGUgUlBNIHJlcG9zaXRvcmllcyIKICAgICAgICAgICAgICAgIHJrZTJfcnBtX2NoYW5uZWw9InN0YWJsZSIKICAgICAgICAgICAgZmkKICAgICAgICAgICAgOzsKICAgICAgICAqKQogICAgICAgICAgICBnZXRfcmVsZWFzZV92ZXJzaW9uCiAgICAgICAgICAgIHJrZTJfbWFqbWluPSQoZWNobyAiJHtJTlNUQUxMX1JLRTJfVkVSU0lPTn0iIHwgc2VkIC1FIC1lICJzL152KFswLTldK1wuWzAtOV0rKS4qL1wxLyIpCiAgICAgICAgICAgIHJrZTJfcnBtX2NoYW5uZWw9JHsxfQogICAgICAgICAgICA7OwogICAgZXNhYwogICAgaW5mbyAidXNpbmcgJHtya2UyX21ham1pbn0gc2VyaWVzIGZyb20gY2hhbm5lbCAke3JrZTJfcnBtX2NoYW5uZWx9IgogICAgcnBtX3NpdGU9InJwbS5yYW5jaGVyLmlvIgogICAgaWYgWyAiJHtya2UyX3JwbV9jaGFubmVsfSIgPSAidGVzdGluZyIgXTsgdGhlbgogICAgICAgIHJwbV9zaXRlPSJycG0tJHtya2UyX3JwbV9jaGFubmVsfS5yYW5jaGVyLmlvIgogICAgZmkKCiAgICBybSAtZiAke3JlcG9kaXJ9L3JhbmNoZXItcmtlMioucmVwbwogICAgY2F0IDw8LUVPRiA+IiR7cmVwb2Rpcn0vcmFuY2hlci1ya2UyLnJlcG8iCltyYW5jaGVyLXJrZTItY29tbW9uLSR7cmtlMl9ycG1fY2hhbm5lbH1dCm5hbWU9UmFuY2hlciBSS0UyIENvbW1vbiAoJHsxfSkKYmFzZXVybD1odHRwczovLyR7cnBtX3NpdGV9L3JrZTIvJHtya2UyX3JwbV9jaGFubmVsfS9jb21tb24vJHtycG1fc2l0ZV9pbmZpeH0vbm9hcmNoCmVuYWJsZWQ9MQpncGdjaGVjaz0xCnJlcG9fZ3BnY2hlY2s9MApncGdrZXk9aHR0cHM6Ly8ke3JwbV9zaXRlfS9wdWJsaWMua2V5CkVPRgoKICAgIGlmIFsgLXogIiR7SU5TVEFMTF9SS0UyX0NPTU1JVH0iIF07IHRoZW4KICAgIGNhdCA8PC1FT0YgPj4iJHtyZXBvZGlyfS9yYW5jaGVyLXJrZTIucmVwbyIKW3JhbmNoZXItcmtlMi0ke3JrZTJfbWFqbWlufS0ke3JrZTJfcnBtX2NoYW5uZWx9XQpuYW1lPVJhbmNoZXIgUktFMiAke3JrZTJfbWFqbWlufSAoJHsxfSkKYmFzZXVybD1odHRwczovLyR7cnBtX3NpdGV9L3JrZTIvJHtya2UyX3JwbV9jaGFubmVsfS8ke3JrZTJfbWFqbWlufS8ke3JwbV9zaXRlX2luZml4fS8kKHVuYW1lIC1tKQplbmFibGVkPTEKZ3BnY2hlY2s9MQpyZXBvX2dwZ2NoZWNrPTAKZ3Bna2V5PWh0dHBzOi8vJHtycG1fc2l0ZX0vcHVibGljLmtleQpFT0YKICAgIGZpCgogICAgaWYgcnBtIC1xIC0tcXVpZXQgcmtlMi1zZWxpbnV4OyB0aGVuCiAgICAgICAgICAgICMgcmVtb3ZlIHJrZTItc2VsaW51eCBtb2R1bGUgaW4gZWw5IGJlZm9yZSB1cGdyYWRlIHRvIGFsbG93IGNvbnRhaW5lci1zZWxpbnV4IHRvIHVwZ3JhZGUgc2FmZWx5CiAgICAgICAgICAgIGlmIGNoZWNrX2F2YWlsYWJsZV91cGdyYWRlcyBjb250YWluZXItc2VsaW51eCAmJiBjaGVja19hdmFpbGFibGVfdXBncmFkZXMgcmtlMi1zZWxpbnV4ICYmIGNoZWNrX2JyZWFraW5nX3ZlcnNpb24gY29udGFpbmVyLXNlbGludXggMiAxODk7IHRoZW4KICAgICAgICAgICAgICAgIE1PRFVMRV9QUklPUklUWT0kKHNlbW9kdWxlIC0tbGlzdD1mdWxsIHwgZ3JlcCBya2UyIHwgY3V0IC1mMSAtZCIgIikKICAgICAgICAgICAgICAgIGlmIFsgLW4gIiR7TU9EVUxFX1BSSU9SSVRZfSIgXTsgdGhlbgogICAgICAgICAgICAgICAgICAgIHNlbW9kdWxlIC1YICRNT0RVTEVfUFJJT1JJVFkgLXIgcmtlMiB8fCB0cnVlCiAgICAgICAgICAgICAgICBmaQogICAgICAgICAgICBmaQogICAgZmkKCiAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9WRVJTSU9OfSIgXSAmJiBbIC16ICIke0lOU1RBTExfUktFMl9DT01NSVR9IiBdOyB0aGVuCiAgICAgICAgJHtycG1faW5zdGFsbGVyfSBpbnN0YWxsIC15ICJya2UyLSR7SU5TVEFMTF9SS0UyX1RZUEV9IgogICAgZWxpZiBbIC1uICIke0lOU1RBTExfUktFMl9DT01NSVR9IiBdOyB0aGVuCiAgICAgICAgcmVsX2Rpc3Rybz0iJChlY2hvICIke3JwbV9zaXRlX2luZml4fSIgfCB0ciAtZCAvKSIKICAgICAgICBpbnN0YWxsX2Rldl9ycG0gIiR7cnBtX2luc3RhbGxlcn0iICIke3JlbF9kaXN0cm99IgogICAgZWxzZQogICAgICAgIHJrZTJfcnBtX3ZlcnNpb249JChlY2hvICIke0lOU1RBTExfUktFMl9WRVJTSU9OfSIgfCBzZWQgLUUgLWUgInMvW1wrLV0vfi9nIiB8IHNlZCAtRSAtZSAicy92KC4qKS9cMS8iKQogICAgICAgIGlmIFsgLW4gIiR7SU5TVEFMTF9SS0UyX1JQTV9SRUxFQVNFX1ZFUlNJT059IiBdOyB0aGVuCiAgICAgICAgICAgICR7cnBtX2luc3RhbGxlcn0gaW5zdGFsbCAteSAicmtlMi0ke0lOU1RBTExfUktFMl9UWVBFfS0ke3JrZTJfcnBtX3ZlcnNpb259LSR7SU5TVEFMTF9SS0UyX1JQTV9SRUxFQVNFX1ZFUlNJT059IgogICAgICAgIGVsc2UKICAgICAgICAgICAgJHtycG1faW5zdGFsbGVyfSBpbnN0YWxsIC15ICJya2UyLSR7SU5TVEFMTF9SS0UyX1RZUEV9LSR7cmtlMl9ycG1fdmVyc2lvbn0iCiAgICAgICAgZmkKICAgIGZpCn0KCmNoZWNrX2JyZWFraW5nX3ZlcnNpb24oKSB7CiAgbWFqPSQyCiAgbWluPSQzCgogIGN1cnJlbnRfbWFqPSQocnBtIC1xaSAkMSB8IGF3ayAtRic6ICcgJy9WZXJzaW9uLyB7cHJpbnQgJDJ9JyB8IHNlZCAtRSAtZSAicy9eKFswLTldKylcLihbMC05XSspLiovXDEvIikKICBjdXJyZW50X21pbj0kKHJwbSAtcWkgJDEgfCBhd2sgLUYnOiAnICcvVmVyc2lvbi8ge3ByaW50ICQyfScgfCBzZWQgLUUgLWUgInMvXihbMC05XSspXC4oWzAtOV0rKS4qL1wyLyIpCgogIGlmIFsgIiR7Y3VycmVudF9tYWp9IiA9PSAiJHttYWp9IiBdICYmIFsgJGN1cnJlbnRfbWluIC1sZSAkbWluIF07IHRoZW4KICAgIHJldHVybiAwCiAgZmkKCiAgcmV0dXJuIDEKfQoKY2hlY2tfYXZhaWxhYmxlX3VwZ3JhZGVzKCkgewogICAgLiAvZXRjL29zLXJlbGVhc2UKICAgIHNldCArZQogICAgaWYgWyAiJHtJRF9MSUtFJSVbIF0qfSIgPSAic3VzZSIgXTsgdGhlbgogICAgICAgIGF2YWlsYWJsZV91cGdyYWRlcz0kKHp5cHBlciAtcSAtdCAtcyAxMSBzZSAtcyAtdSAtLXR5cGUgcGFja2FnZSAkMSB8IHRhaWwgLW4gMSB8IGdyZXAgLXYgIk5vIG1hdGNoaW5nIiB8IGF3ayAne3ByaW50ICQzfScpCiAgICBlbHNlCiAgICAgICAgYXZhaWxhYmxlX3VwZ3JhZGVzPSQoeXVtIC1xIC0tcmVmcmVzaCBsaXN0ICQxIC0tdXBncmFkZXMgfCB0YWlsIC1uIDEgfCBhd2sgJ3twcmludCAkMn0nKQogICAgZmkKICAgIHNldCAtZQogICAgaWYgWyAtbiAiJHthdmFpbGFibGVfdXBncmFkZXN9IiBdOyB0aGVuCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICByZXR1cm4gMQp9Cgpkb19pbnN0YWxsX3RhcigpIHsKICAgIHNldHVwX3RtcAoKICAgIGlmIFsgLW4gIiR7SU5TVEFMTF9SS0UyX0FSVElGQUNUX1BBVEh9IiBdOyB0aGVuCiAgICAgICAgc3RhZ2VfbG9jYWxfY2hlY2tzdW1zCiAgICAgICAgc3RhZ2VfbG9jYWxfYWlyZ2FwX3RhcmJhbGwKICAgICAgICBzdGFnZV9sb2NhbF90YXJiYWxsCiAgICBlbHNlCiAgICAgICAgZ2V0X3JlbGVhc2VfdmVyc2lvbgogICAgICAgIGluZm8gInVzaW5nICR7SU5TVEFMTF9SS0UyX1ZFUlNJT046LWNvbW1pdCAkSU5TVEFMTF9SS0UyX0NPTU1JVH0gYXMgcmVsZWFzZSIKICAgICAgICBkb3dubG9hZF9haXJnYXBfY2hlY2tzdW1zCiAgICAgICAgZG93bmxvYWRfYWlyZ2FwX3RhcmJhbGwKICAgICAgICBkb3dubG9hZF9jaGVja3N1bXMKICAgICAgICBkb3dubG9hZF90YXJiYWxsCiAgICBmaQoKICAgIHZlcmlmeV9haXJnYXBfdGFyYmFsbAogICAgaW5zdGFsbF9haXJnYXBfdGFyYmFsbAogICAgdmVyaWZ5X3RhcmJhbGwKICAgIHVucGFja190YXJiYWxsCgogICAgaWYgWyAteiAiJHtJTlNUQUxMX1JLRTJfU0tJUF9SRUxPQUR9IiBdOyB0aGVuCiAgICAgICAgc3lzdGVtY3RsIGRhZW1vbi1yZWxvYWQKICAgIGZpCn0KCnNldHVwX2ZhcG9saWN5X3J1bGVzKCkgewogICAgaWYgWyAtciAvZXRjL3JlZGhhdC1yZWxlYXNlIF0gfHwgWyAtciAvZXRjL2NlbnRvcy1yZWxlYXNlIF0gfHwgWyAtciAvZXRjL29yYWNsZS1yZWxlYXNlIF0gfHwgWyAtciAvZXRjL3JvY2t5LXJlbGVhc2UgXSB8fCBbIC1yIC9ldGMvc3lzdGVtLXJlbGVhc2UgXTsgdGhlbgogICAgICAgIHZlcmlmeV9mYXBvbGljeWQgfHwgcmV0dXJuIDAKICAgICAgICAjIHNldHRpbmcgcmtlMiBmYXBvbGljeWQgcnVsZXMKICAgICAgICBjYXQgPDwtRU9GID4iL2V0Yy9mYXBvbGljeWQvcnVsZXMuZC84MC1ya2UyLnJ1bGVzIgphbGxvdyBwZXJtPWFueSBhbGwgOiBkaXI9L3Zhci9saWIvcmFuY2hlci8KYWxsb3cgcGVybT1hbnkgYWxsIDogZGlyPS9vcHQvY25pLwphbGxvdyBwZXJtPWFueSBhbGwgOiBkaXI9L3J1bi9rM3MvCmFsbG93IHBlcm09YW55IGFsbCA6IGRpcj0vdmFyL2xpYi9rdWJlbGV0LwpFT0YKICAgICAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9TS0lQX1JFTE9BRH0iIF07IHRoZW4KICAgICAgICAgICAgZmFnZW5ydWxlcyAtLWxvYWQgfHwgZmF0YWwgImZhaWxlZCB0byBsb2FkIHJrZTIgZmFwb2xpY3lkIHJ1bGVzIgogICAgICAgICAgICBzeXN0ZW1jdGwgcmVzdGFydCBmYXBvbGljeWQKICAgICAgICBmaQogICAgZmkKfQoKZG9faW5zdGFsbCgpIHsKICAgIHNldHVwX2VudgogICAgY2hlY2tfbWV0aG9kX2NvbmZsaWN0CiAgICBzZXR1cF9hcmNoCiAgICBpZiBbIC16ICIke0lOU1RBTExfUktFMl9BUlRJRkFDVF9QQVRIfSIgXTsgdGhlbgogICAgICAgIHZlcmlmeV9kb3dubG9hZGVyIGN1cmwgfHwgdmVyaWZ5X2Rvd25sb2FkZXIgd2dldCB8fCBmYXRhbCAiY2FuIG5vdCBmaW5kIGN1cmwgb3Igd2dldCBmb3IgZG93bmxvYWRpbmcgZmlsZXMiCiAgICBmaQoKICAgIGNhc2UgJHtJTlNUQUxMX1JLRTJfTUVUSE9EfSBpbgogICAgeXVtIHwgcnBtIHwgZG5mKQogICAgICAgIGRvX2luc3RhbGxfcnBtICIke0lOU1RBTExfUktFMl9DSEFOTkVMfSIKICAgICAgICA7OwogICAgKikKICAgICAgICBkb19pbnN0YWxsX3RhciAiJHtJTlNUQUxMX1JLRTJfQ0hBTk5FTH0iCiAgICAgICAgOzsKICAgIGVzYWMKICAgIGlmIFsgLXogIiR7SU5TVEFMTF9SS0UyX1NLSVBfRkFQT0xJQ1l9IiBdOyB0aGVuCiAgICAgICAgc2V0dXBfZmFwb2xpY3lfcnVsZXMKICAgIGZpCn0KCmRvX2luc3RhbGwKZXhpdCAwCg=="
    owner: root:root
    permissions: '0755'

power_state:
  mode: reboot
  message: rebooting
  timeout: 10
  condition: True

runcmd:
  - "systemctl restart wicked"
  - "firewall-cmd --add-port=6443/tcp --permanent"
  - "firewall-cmd --add-port=2379-2380/tcp --permanent"
  - "firewall-cmd --add-port=10250/tcp --permanent"
  - "firewall-cmd --add-port=10251/tcp --permanent"
  - "firewall-cmd --add-port=10252/tcp --permanent"
  - "firewall-cmd --add-port=9345/tcp --permanent"
  - "firewall-cmd --add-port=8472/udp --permanent"
  - "firewall-cmd --add-port=30000-32767/tcp --permanent"
  - "firewall-cmd --reload"
  - "INSTALL_RKE2_VERSION='${rke2_version}' /opt/rke2-install.sh"
  - "systemctl enable rke2-server"
  - "echo '${ad_password}' | realm join -U '${ad_password}' '${ad_domain}'"
